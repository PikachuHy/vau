<!DOCTYPE html>
<html>
<head>
<style>
html {
	background-color: #6e6e91;
}

.center {
  display: block;
  margin-left: auto;
  margin-right: auto;
  width: 50%;
}
</style>
<script type='text/javascript'>

"use strict";

var vauView = {};

const worker = new Worker("vau_worker.js");
const messagePromises = new Map();
let lastPromiseId = 0;

vauView.ready = new Promise((resolve, reject) => {
	worker.onmessage = function (event) {
		let type = event.data[0];
		if (type === "READY") {
			vauView.wasmMemory = event.data[1];
			let methodNames = event.data[2];
			for (let method of methodNames)
			  vauView[method] = wrap(method);
			worker.onmessage = onWorkerMessage;
			resolve();
		} else if (type === "ERROR") {
			let error = event.data[1];
			reject(new Error(error));
		} else {
			reject(new Error(`Unexpected first message: ${event.data}`));
		}
	};
});

function onWorkerMessage(event) {
	let [ type, id, result ] = event.data;
	if (type === "RESULT")
		messagePromises.get(id).resolve(result);
	else if (type === "READY")
		messagePromises.get(id).reject(new Error("Unexpected READY message"));
	else if (type === "ERROR") {
		let error = new Error(result.message);
		error.name = result.name;
		error.stack = result.stack;
		messagePromises.get(id).reject(error);
	}
	else
		messagePromises.get(id).reject(new Error(`Unexpected result type '${type}'`));

	messagePromises.delete(id);
}

// TODO - Add cancelation for trylater queues
function wrap(func) {
	return function(...args) {
		return new Promise(function (resolve, reject) {
			let id = lastPromiseId++;
			messagePromises.set(id, { resolve, reject });
			if (args[0] instanceof ArrayBuffer)
				worker.postMessage([func, id, args], [args[0]]);
			else
				worker.postMessage([func, id, args]);
		});
	};
}


function openDocument(str) {
	var status = document.getElementById("status");
	status.innerHTML = `Typesetting ${str} ...`;
	console.log(`Typesetting ${str} ...`);
	vauView.openDocument(str).then( () => {
   	  	console.log(`Typesetting ${str} DONE`);
		status.innerHTML = `DONE Typesetting ${str}`;	
	} );
}

function updateImage() { 
	var doc = FS.readFile("/vau-test.png");
	var img = document.getElementById("image");
	img.src = URL.createObjectURL(new Blob([doc], { type: "image/png" }));
}

function showPage (n) {
	//_wasm_get_page_png(n);
	//updateImage();
    vauView.getPagePixmap(n).then( (pix) => {
  	  var canvas = document.getElementById('canvas');
	  canvas.width= pix.width;
	  canvas.height= pix.height;
	  var ctx = canvas.getContext('2d');
	  ctx.putImageData(pix, 0, 0);

	  updateStatus();
	});
}

</script>
</head>
<body>
<div id="status">LOADING...</div>
<!---img id="image" width="900px" class="center"--->
<canvas id="canvas" width="900px" class="center">
</body>
<script>
var page=1;
var zoom=1;


function updateStatus() {
	var status = document.getElementById("status");
	status.innerHTML = `Page ${page} | Zoom ${Math.round(zoom*100)/100}`;
}


function runViewer() {
	openDocument("$TEXMACS_PATH/vau-tests/ibp-exponential-example.tm");

//	openDocument("$TEXMACS_PATH/examples/texts/bracket-test.tm");
	
	showPage(page);

	window.addEventListener("keydown", function (event) {
		console.log(event);
		if (event.key == "PageDown") {
			showPage(page);
			console.log("PAGEDOWN");
			page= page+1;
		    showPage(page);
			event.preventDefault();
		}
		if (event.key == "PageUp") {
			console.log("PAGEUP");
			if (page > 1) {
				page= page-1;
		    	showPage(page);
			}
			event.preventDefault();
		}
		if (event.key == "+") {
			console.log("ZOOMIN");
			zoom = zoom*1.2;
			var img = document.getElementById("canvas");
			img.style.width=`${zoom*1000}px`;
			updateStatus();
			event.preventDefault();
		}
		if (event.key == "-") {
			console.log("ZOOMOUT");
			zoom = zoom/1.2;
			var img = document.getElementById("canvas");
			img.style.width=`${zoom*1000}px`;
			updateStatus();
			event.preventDefault();
		}
	});
}

vauView.ready.then(() => {runViewer()});

</script>
</html>
