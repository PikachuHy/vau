<!DOCTYPE html>
<html>
<head>
<style>
html {
	background-color: #6e6e91;
}

.center {
  display: block;
  margin-left: auto;
  margin-right: auto;
  width: 50%;
}
</style>
<script type='text/javascript'>
var VauWasm = {
  	preRun: [function () {
		var status = document.getElementById("status");
		status.innerHTML = "INITIALIZING...";
  	}], 
  	logReadFiles: true,
  	postRun: [function () {
		var status = document.getElementById("status");
		status.innerHTML = "READY.";
		runViewer();
  	}]
};

function allocateUTF8(str) {
	var size = lengthBytesUTF8(str) + 1;
	var pointer = _malloc(size);
	stringToUTF8(str, pointer, size);
	return pointer;
}

function openDocument(str) {
	var p= allocateUTF8(str);
	_wasm_open_document(p);
	_free(p)
}

function updateImage() { 
	var doc = FS.readFile("/vau-test.png");
	var img = document.getElementById("image");
	img.src = URL.createObjectURL(new Blob([doc], { type: "image/png" }));
}

function showPage(n) {
	_wasm_get_page_png(n);
	updateImage();
	updateStatus();
}


</script>
<script src="Vau.js"></script>
</head>
<body>
<div id="status">LOADING...</div>
<img id="image" width="900px" class="center">
</body>
<script>
var page=1;
var zoom=1;


function updateStatus() {
	var status = document.getElementById("status");
	status.innerHTML = `Page ${page} | Zoom ${zoom}`;
}


function runViewer() {
	openDocument("$TEXMACS_PATH/vau-tests/grassmann-sq-example.tm");
	showPage(page);

	window.addEventListener("keydown", function (event) {
		console.log(event);
		if (event.key == "PageDown") {
			showPage(page);
			console.log("PAGEDOWN");
			page= page+1;
		    showPage(page);
			event.preventDefault();
		}
		if (event.key == "PageUp") {
			console.log("PAGEUP");
			if (page > 1) {
				page= page-1;
		    	showPage(page);
			}
			event.preventDefault();
		}
		if (event.key == "+") {
			console.log("ZOOMIN");
			zoom = zoom*1.2;
			var img = document.getElementById("image");
			img.style.width=`${zoom*1000}px`;
			updateStatus();
			event.preventDefault();
		}
		if (event.key == "-") {
			console.log("ZOOMOUT");
			zoom = zoom/1.2;
			var img = document.getElementById("image");
			img.style.width=`${zoom*1000}px`;
			updateStatus();
			event.preventDefault();
		}
	});
}
</script>
</html>
